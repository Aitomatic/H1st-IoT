#!/usr/bin/env python


import argparse
import os
from ruamel import yaml
import shutil

from arimo.IoT.DataAdmin._django_root.settings import _CONFIG_FILE_PATH
from arimo.IoT.DataAdmin.util import _YAML_EXT
from arimo.IoT.PredMaint import Project

parser = argparse.ArgumentParser()
parser.add_argument('project')
args = parser.parse_args()


config_file_path = \
    os.path.join(
        Project.CONFIG_LOCAL_DIR_PATH,
        args.project + _YAML_EXT)

db_creds = yaml.safe_load(stream=open(config_file_path, 'r'))['db']
assert db_creds['host'] \
   and db_creds['db_name'] \
   and db_creds['user'] \
   and db_creds['password']

CONFIG_ORIG_FILE_PATH = _CONFIG_FILE_PATH + '.orig'

assert not os.path.isfile(CONFIG_ORIG_FILE_PATH)

shutil.copyfile(
    src=_CONFIG_FILE_PATH,
    dst=CONFIG_ORIG_FILE_PATH)

assert os.path.isfile(CONFIG_ORIG_FILE_PATH)

shutil.copyfile(
    src=config_file_path,
    dst=_CONFIG_FILE_PATH)

os.system('python3 manage.py migrate')

shutil.copyfile(
    src=CONFIG_ORIG_FILE_PATH,
    dst=_CONFIG_FILE_PATH)

os.remove(CONFIG_ORIG_FILE_PATH)

assert not os.path.isfile(CONFIG_ORIG_FILE_PATH)
